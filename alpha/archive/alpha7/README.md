# Alpha#7: 条件性趋势反转与交易量确认

## 描述

Alpha#7 的计算公式为：

```
((adv20 < volume) ? ((-1 * ts_rank(abs(delta(close, 7)), 60)) * sign(delta(close, 7))) : (-1*1))
```

这个 Alpha 策略是一个条件性的因子，它结合了近期价格变动、历史价格波动排名以及当前成交量与近期平均成交量的比较。

**核心逻辑**:

1.  **交易量条件 (`adv20 < volume`)**:
    *   `adv20`: 过去20天的平均日成交额。
    *   `volume`: 当天的成交量。 (注：原文公式为`volume`，通常指成交量，但`adv20`通常指成交额。这里假设`volume`指当日成交额以便与`adv20`比较，或者`adv20`实为平均成交量。代码实现时将基于`mock_data.csv`中`volume`字段的含义，通常为成交量股数。如果`adv{d}`代表成交额，则需要`vwap`数据来计算当日成交额 `close * volume` 或 `vwap * volume`。为简化，这里假设`volume`和`adv20`是可直接比较的量纲，如均为成交量或均为成交额。模拟数据`mock_data.csv`中`volume`为成交量，因此后续将假设`adv20`也为平均成交量。)
    *   **条件成立 (`adv20 < volume`)**: 当日成交量（额）显著大于过去20天平均水平，表明市场活跃度增加，此时启用趋势反转逻辑。
    *   **条件不成立 (`adv20 >= volume`)**: 当日成交量（额）未显著放大，策略直接输出 `-1`，表示一个固定的负向信号。

2.  **趋势反转逻辑 (当 `adv20 < volume`)**:
    *   `delta(close, 7)`: 当日收盘价 (`close`) 与7天前收盘价的差值，反映了过去一周的价格变动。
    *   `sign(delta(close, 7))`: 取价格变动的方向。正号表示过去7天价格上涨，负号表示下跌。
    *   `abs(delta(close, 7))`: 取价格变动的绝对幅度。
    *   `ts_rank(abs(delta(close, 7)), 60)`: 过去60天内，每日的"7日价格变动绝对幅度"进行时间序列排名。排名越高，表示当天的7日价格变动幅度在过去60天中越大。这是一个0到1之间的值 (或者1到N，取决于具体实现，这里假设是百分比排名0-1)。
    *   核心部分: `(-1 * ts_rank(abs(delta(close, 7)), 60)) * sign(delta(close, 7))`
        *   如果过去7天价格上涨 (`sign`为+1): Alpha = `-1 * ts_rank(...)`。这意味着近期涨幅越大（`ts_rank`越高），Alpha信号越负。这是一个反转信号，预期上涨后会回调。
        *   如果过去7天价格下跌 (`sign`为-1): Alpha = `(-1 * ts_rank(...)) * -1 = ts_rank(...)`。这意味着近期跌幅越大（`ts_rank`越高），Alpha信号越正。这是一个反转信号，预期下跌后会反弹。

**总结**:
*   在成交量放大的前提下，Alpha#7对近期显著的价格趋势（无论是上涨还是下跌）采取反向操作的观点。趋势的"显著性"由其在过去60天内的相对排名确定。
*   如果成交量未放大，策略固定看跌。

## 项目结构

```
alpha-mining/
├── data/
│   ├── generate_mock_data.py  # 脚本：生成模拟金融数据
│   └── mock_data.csv          # 生成的模拟数据文件
├── alpha/alpha7/
│   ├── alpha_calculator.py    # 脚本：根据公式计算 Alpha#7
│   ├── alpha7_results.csv     # 计算得到的 Alpha#7 结果文件
│   ├── README.md              # 本说明文档
│   └── cast.md                # Alpha#7 策略总结
```

## 使用步骤

### 1. 环境准备

确保您的 Python 环境中安装了 `pandas` 和 `numpy` 库。如果未安装，可以通过 pip 安装：

```bash
pip install pandas numpy
```

### 2. 生成模拟数据 (如果需要)

本 Alpha 依赖于 `close`, `volume` 数据。`data/generate_mock_data.py` 脚本可以生成这些数据。如果 `data/mock_data.csv` 不存在或需要更新：

```bash
cd data
python generate_mock_data.py
cd ..
```
该脚本默认生成5只资产100天的数据。请确保生成的数据包含 `close` 和 `volume` 列。脚本会生成 `adv20`（基于volume）。

### 3. 计算 Alpha#7 因子

进入 `alpha/alpha7` 目录并运行 `alpha_calculator.py` 脚本：

```bash
cd alpha/alpha7
python alpha_calculator.py
```

脚本将读取 `../../data/mock_data.csv`，计算 Alpha#7，并将结果保存到当前目录下的 `alpha7_results.csv`。同时会在终端打印部分结果和统计信息。

## Alpha#7 策略解读与计算示例

Alpha#7 是一个结合成交量过滤的动量反转策略。

为了更好地理解计算过程，我们以 `alpha7_results.csv` 中 `asset_1` 在 `2025-03-12` 的数据为例进行分析。

### 实际数据快照 (asset_1, 2025-03-12)

从 `alpha7_results.csv` 中提取的相关数据：

| date       | asset_id | close  | volume   | adv20      | delta_close_7 | abs_delta_close_7 | ts_rank_abs_delta_close_7 | sign_delta_close_7 | alpha7 |
|------------|----------|--------|----------|------------|---------------|-------------------|---------------------------|--------------------|--------|
| 2025-03-12 | asset_1  | 90.20  | 3514264  | 962190.65  | 0.00          | 0.00              | 0.03                      | 0.00               | -0.00  |

*(注意：ts_rank_abs_delta_close_7 和 alpha7 的实际值取决于完整数据集和具体窗口内的所有数据点进行计算得到，表格中为四舍五入后的结果。alpha7列的-0.00是由于计算结果接近0并保留两位小数所致，实际可能是非常小的正数或负数，或精确为0)*

### 计算步骤详解 (asset_1, 2025-03-12):

1.  **收集数据** (截至 2025-03-12):
    *   `close` (当日收盘价): 90.20
    *   `volume` (当日成交量): 3,514,264
    *   `adv20` (过去20日平均成交量): 962,190.65 (由脚本计算得出)
    *   `close_7_days_ago` (2025-03-05 的收盘价): 假设为 90.20 (因为 `delta_close_7` 为 0.00)
    *   `ts_rank_abs_delta_close_7` (0.00 在过去60天 `abs(delta(close,7))` 值中的排名): 0.03 (由脚本计算得出)

2.  **交易量条件**:
    *   `adv20 < volume` ?
    *   `962190.65 < 3514264` -> **True**.
    *   因此，执行趋势反转逻辑。

3.  **价格变动计算**:
    *   `delta_close_7` = `close` - `close_7_days_ago` = 90.20 - 90.20 = 0.00.
    *   `sign_delta_close_7` = `sign(0.00)` = 0.00.
    *   `abs_delta_close_7` = `abs(0.00)` = 0.00.

4.  **时间序列排名**:
    *   `ts_rank_abs_delta_close_7` = 0.03 (来自数据).

5.  **最终 Alpha 值**:
    *   `Alpha#7` = `(-1 * ts_rank_abs_delta_close_7) * sign_delta_close_7`
    *   `Alpha#7` = `(-1 * 0.03) * 0.00`
    *   `Alpha#7` = `0.00` (保留两位小数后为 -0.00 或 0.00)

**解读 (asset_1, 2025-03-12)**:
当日成交量 (3,514,264) 远大于过去20天平均成交量 (962,190.65)，因此交易量条件满足，策略激活。
然而，过去7天的价格变动 (`delta_close_7`) 为0，其绝对值的时间序列排名 (`ts_rank_abs_delta_close_7`) 也非常低 (0.03)。这表明虽然市场活跃，但该资产近期价格无明显趋势或波动。因此，`sign_delta_close_7` 为0，导致最终的Alpha#7信号也为0 (或接近0)。这符合策略逻辑：在没有显著价格变动的情况下，即使成交量放大，也不产生强烈的反转信号。

**另一个示例 (asset_4, 2025-04-07)**:

| date       | asset_id | close | volume  | adv20     | delta_close_7 | abs_delta_close_7 | ts_rank_abs_delta_close_7 | sign_delta_close_7 | alpha7 |
|------------|----------|-------|---------|-----------|---------------|-------------------|---------------------------|--------------------|--------|
| 2025-04-07 | asset_4  | 82.00 | 2808845 | 1204018.25 | -2.00         | 2.00              | 0.53                      | -1.00              | 0.53   |

1.  **交易量条件**: `1204018.25 < 2808845` -> **True**.
2.  **价格变动**: `delta_close_7` = -2.00, `sign_delta_close_7` = -1.00, `abs_delta_close_7` = 2.00.
3.  **时间序列排名**: `ts_rank_abs_delta_close_7` = 0.53.
4.  **最终 Alpha 值**: `Alpha#7 = (-1 * 0.53) * -1.00 = 0.53`.

**解读 (asset_4, 2025-04-07)**:
成交量放大。过去7天价格下跌2.00个单位，这个跌幅在过去60天中处于中等偏上水平 (排名0.53)。因此，策略给出一个正向信号 (0.53)，预期价格可能反弹。

### Alpha#7 实际数据统计 (基于 alpha7_results.csv)

对 `alpha7_results.csv` 中 `alpha7` 列（排除了因窗口期不足产生的NaN值）进行描述性统计，可以得到类似如下的结果 (具体数值会根据您的 `mock_data.csv` 和计算脚本的精确运行而变化)：

```
# 实际统计输出自某次运行 alpha_calculator.py
count   408.00
mean     -0.80
std       0.49
min      -1.00
25%      -1.00
50%      -1.00
75%      -1.00
max       1.00
Name: alpha7, dtype: float64
```
*(请运行 `alpha_calculator.py` 脚本以获取您数据对应的确切统计信息，以上为一次运行示例)*

这组统计数据显示了 Alpha#7 因子在模拟数据上的分布情况，包括其均值、标准差、最小值、最大值和四分位数。例如，此示例中均值为-0.80，表明在该特定模拟数据和窗口期设置下，策略产生的负向信号（包括未触发成交量条件时的-1.00固定信号）显著多于或强于正向信号。最大值为1.00和最小值为-1.00符合公式定义。

## 数据需求
*   `date`: 交易日期
*   `asset_id`: 资产ID
*   `close`: 当日收盘价
*   `volume`: 当日成交量 (用于计算 `adv20` 和与 `adv20` 比较)

## 输出格式
输出的 CSV 文件 (`alpha7_results.csv`) 将包含以下列：
*   `date`: 交易日期
*   `asset_id`: 资产ID
*   `close`: 当日收盘价 (原始数据)
*   `volume`: 当日成交量 (原始数据)
*   `adv20`: 过去20日平均成交量 (计算中间值)
*   `delta_close_7`: 7日价格差 (计算中间值)
*   `abs_delta_close_7`: 7日价格差绝对值 (计算中间值)
*   `ts_rank_abs_delta_close_7`: 7日价格差绝对值的时间序列排名 (计算中间值)
*   `sign_delta_close_7`: 7日价格差的符号 (计算中间值)
*   `alpha7`: 计算得到的 Alpha#7 值，保留两位小数。

## 注意事项与风险提示
*   **数据窗口**: `delta(close, 7)` 需要至少7天历史数据，`ts_rank(..., 60)` 需要至少60天历史数据，`adv20` 需要至少20天历史数据。因此，在数据序列的早期，Alpha 值可能为 NaN。
*   **成交量定义**: 明确 `volume` 和 `adv20` 指的是成交量还是成交额。本处按成交量处理。如果原始数据提供成交额，计算逻辑需要相应调整。
*   `ts_rank` 实现: `ts_rank` 的具体实现（例如，是返回0-1的百分比排名还是1-N的序数排名）会影响最终 Alpha 值的范围和解释。这里假设为0-1的百分比排名。
*   **固定信号**: 当成交量不满足条件时，策略固定输出 -1。这种一刀切的逻辑可能在某些市场条件下表现不佳。
*   **反转策略风险**: 反转策略在趋势性强的市场中可能表现不佳。
*   Alpha#7 是基于历史价格和成交量模式的统计策略，不保证未来表现。建议与其他因子结合使用，并进行充分的回测验证。

如需帮助或有建议，欢迎交流！ 