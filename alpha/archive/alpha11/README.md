# Alpha#11: VWAP与收盘价差值的极值与成交量变动的综合排名

## 描述

Alpha#11 的计算公式为：

```
Alpha#11: ((rank(ts_max((vwap - close), 3)) + rank(ts_min((vwap - close), 3))) * rank(delta(volume, 3)))
```

这个 Alpha 策略结合了近期VWAP与收盘价差值的极端表现和成交量的变化趋势。具体来说，它计算了：

1. 过去3天内"成交量加权平均价（vwap）与收盘价（close）之差"的最大值，并对其进行截面排名。
2. 过去3天内"成交量加权平均价（vwap）与收盘价（close）之差"的最小值，并对其进行截面排名。
3. 过去3天成交量（volume）的变化值（今天的成交量减去3天前的成交量），并对其进行截面排名。

然后，将前两个排名相加，再乘以第三个排名，得到最终的 Alpha#11 值。这种设计旨在捕捉那些近期价格偏离其成交量加权均线达到极值，并且成交量也发生显著变化的资产。

## 项目结构

```
alpha-mining/
├── data/
│   ├── generate_mock_data.py  # 脚本：生成模拟金融数据
│   └── mock_data.csv          # 生成的模拟数据文件
├── alpha/alpha11/
│   ├── alpha_calculator.py    # 脚本：根据公式计算 Alpha#11
│   ├── alpha11_results.csv    # 计算得到的 Alpha#11 结果文件
│   ├── README.md              # 本说明文档
│   └── cast.md                # Alpha#11 策略总结
...
```

## 使用步骤

### 1. 环境准备

确保您的 Python 环境中安装了 `pandas` 库。如果未安装，可以通过 pip 安装：

```bash
pip install pandas
```

### 2. 模拟数据

本 Alpha 依赖于 `vwap`, `close`, 和 `volume` 数据。这些数据应存在于 `data/mock_data.csv` 文件中。如果该文件不存在或需要更新，可以运行 `data/generate_mock_data.py` 脚本。

```bash
cd ../../data  # 假设当前在 alpha/alpha11 目录
python generate_mock_data.py
cd ../alpha/alpha11 # 返回 alpha/alpha11 目录
```

该脚本默认生成包含所需字段的模拟数据。

### 3. 计算 Alpha#11 因子

进入 `alpha/alpha11` 目录并运行 `alpha_calculator.py` 脚本：

```bash
python alpha_calculator.py
```

脚本将读取 `../../data/mock_data.csv`，计算 Alpha#11，并将结果（包含原始数据列和中间计算值）保存到当前目录下的 `alpha11_results.csv`。

## Alpha#11 策略解读与计算示例

Alpha#11 因子试图识别出那些"VWAP与收盘价的差值"在短期内（3天）出现极端值（最大或最小），并且成交量在同期也发生显著变化（3天差值）的资产。

为了更好地理解计算过程，我们以 `alpha11_results.csv` 中 `asset_1` 在 `2025-01-04` 的数据为例进行分析。

### 实际数据快照 (asset_1, 2025-01-04)

从 `alpha11_results.csv` 中提取的相关数据 (为便于展示，部分列名已缩写，具体请参照完整输出文件):

| date       | asset_id | close | vwap   | volume  | vwap_close_diff | ts_max_diff_3 | ts_min_diff_3 | delta_volume_3 | rank_max | rank_min | rank_vol | alpha11 |
|------------|----------|-------|--------|---------|-----------------|---------------|---------------|----------------|----------|----------|----------|---------|
| 2025-01-01 | asset_1  | 100.00| 100.32 | 690896  | 0.32            | NaN           | NaN           | NaN            | NaN      | NaN      | NaN      | NaN     |
| 2025-01-02 | asset_1  | 100.10| 100.41 | 1236310 | 0.31            | NaN           | NaN           | NaN            | NaN      | NaN      | NaN      | NaN     |
| 2025-01-03 | asset_1  | 100.20| 100.39 | 794092  | 0.19            | 0.32          | 0.19          | NaN            | 0.20     | 1.00     | NaN      | NaN     |
| **2025-01-04** | **asset_1**  | **99.40** | **100.42** | **1279416** | **1.02**          | **1.02**        | **0.19**        | **588520.00**  | **0.80**   | **1.00**   | **1.00**   | **1.80**  |
| 2025-01-05 | asset_1  | 100.50| 100.40 | 1327947 | -0.10           | 1.02          | -0.10         | 91637.00       | 0.80     | 1.00     | 0.40     | 0.72    |

*(注意：表格中为脚本输出的精确值或四舍五入后的结果，NaN代表因为窗口期不足等原因无法计算)*

### 计算步骤详解 (asset_1, 2025-01-04):

1.  **收集数据并计算基础指标** (截至 2025-01-04):
    *   `vwap_close_diff` 序列 (过去三天，包括当天):
        *   2025-01-02: 0.31 (`100.41 - 100.10`)
        *   2025-01-03: 0.19 (`100.39 - 100.20`)
        *   2025-01-04: 1.02 (`100.42 - 99.40`)
    *   `volume` 序列 (需要用于计算 delta_volume_3):
        *   2025-01-01: 690896
        *   2025-01-02: 1236310
        *   2025-01-03: 794092
        *   2025-01-04: 1279416

2.  **计算时间序列指标**:
    *   `ts_max_diff_3` for 2025-01-04: `max([0.31, 0.19, 1.02])` = 1.02
    *   `ts_min_diff_3` for 2025-01-04: `min([0.31, 0.19, 1.02])` = 0.19
    *   `delta_volume_3` for 2025-01-04: `volume_today - volume_3_days_ago` = `1279416 - 690896` = 588520.00

3.  **横截面排名 (rank)**:
    *   在 `2025-01-04` 这一天，假设 `asset_1` 的：
        *   `ts_max_diff_3` (1.02) 在所有资产中排名得到 `rank_ts_max_diff_3` = 0.80
        *   `ts_min_diff_3` (0.19) 在所有资产中排名得到 `rank_ts_min_diff_3` = 1.00
        *   `delta_volume_3` (588520.00) 在所有资产中排名得到 `rank_delta_volume_3` = 1.00
    *   *(这些排名是百分比排名，值在0到1之间，具体值取决于当日其他资产的表现)*

4.  **计算 Alpha#11**:
    *   `Alpha#11 = (rank_ts_max_diff_3 + rank_ts_min_diff_3) * rank_delta_volume_3`
    *   `Alpha#11 = (0.80 + 1.00) * 1.00 = 1.80 * 1.00 = 1.80`
    *   脚本中保留两位小数，所以最终是 1.80。

**解读 (asset_1, 2025-01-04)**:
在 `2025-01-04` 这一天，`asset_1` 的 `vwap-close` 差值在过去3天内的最大值（1.02）和最小值（0.19）在截面上都有较高的排名（分别为0.80和1.00）。同时，其3日成交量变化（588520.00）在截面上排名也很高（1.00）。这三者结合使得最终的 Alpha#11 值（1.80）较高。这表明该资产近期价格偏离其VWAP的极端情况显著，且成交量也发生了显著的正向变化，符合因子设计的目标。

### Alpha#11 实际数据统计 (基于 alpha11_results.csv)

对 `alpha11_results.csv` 中 `alpha11` 列（排除了因窗口期不足产生的NaN值）进行描述性统计，可以得到如下结果 (具体数值会根据您的 `mock_data.csv` 和计算脚本的精确运行而变化)：

```
# 运行 alpha_calculator.py 后，脚本会输出类似如下的统计信息，
# 请以您运行时产生的真实数据为准。
# 以下为一次运行的示例：
#
# Alpha11 column statistics (excluding NaNs):
# count   490.000000
# mean      0.756347
# std       0.528158
# min       0.080000
# 25%       0.280000
# 50%       0.640000
# 75%       1.120000
# max       2.000000
# Name: alpha11, dtype: float64
```
*(请运行 `alpha_calculator.py` 脚本以获取您数据对应的确切统计信息，以上为一次运行示例)*

这组统计数据显示了 Alpha#11 因子在模拟数据上的分布情况。

- **`vwap - close`**: 这个差值反映了收盘价相对于当日成交量加权平均价的偏离程度。
  - 正值大：收盘价远低于VWAP，可能表示日内下跌压力。
  - 负值大（绝对值大）：收盘价远高于VWAP，可能表示日内上涨动力。
- **`ts_max((vwap - close), 3)` 和 `ts_min((vwap - close), 3)`**: 分别捕捉了过去3天这种偏离程度的最大和最小值。对它们进行排名（`rank`）是为了得到相对强度。
- **`delta(volume, 3)`**: 衡量了3天内成交量的变化。对其进行排名（`rank`）也是为了得到相对强度。
- **综合信号**:
  - `(rank(ts_max) + rank(ts_min))`：这一部分结合了价格偏离的两个极端方向的排名。如果一个资产同时在最大偏离和最小偏离上都有较高的排名（例如，一个方向的极端偏离不明显，而另一个方向的偏离非常显著），这个和可能会指示一些特别的市场状态。
  - `* rank(delta(volume, 3))`：最后乘以成交量变化的排名。这意味着，只有当成交量也显示出显著变化时，前面计算的价格偏离信号才会被放大。

### 信号生成逻辑：

- 一个较大的正 Alpha 值可能意味着：
  - VWAP与收盘价的差值在近期出现了显著的极端值（无论是正向还是负向，或者两者综合排名高），并且
  - 成交量在近期也显著增加（或其他导致排名高的变化）。
- 一个较大的负 Alpha 值（绝对值大）可能反之。

具体的投资含义需要通过回测来验证。例如，如果 (vwap - close) 的 ts_max 排名很高（意味着近期出现过收盘价远低于vwap的情况），同时 (vwap - close) 的 ts_min 排名也很高（意味着近期也出现过收盘价远高于vwap的情况，或者说波动较大但没有明显趋势），且成交量变化排名也高，这可能指向一个成交活跃但方向不明朗的标的。

## 数据需求

- `date`: 交易日期 (YYYY-MM-DD)
- `asset_id`: 资产ID
- `close`: 每日收盘价
- `vwap`: 每日成交量加权平均价
- `volume`: 每日成交量

## 输出格式

输出的 CSV 文件 (`alpha11_results.csv`) 包含以下列：

- `date`: 交易日期
- `asset_id`: 资产ID
- `close`: 当日收盘价（原始数据）
- `vwap`: 当日成交量加权平均价（原始数据）
- `volume`: 当日成交量（原始数据）
- `vwap_close_diff`: `vwap - close` (中间计算值)
- `ts_max_diff_3`: 过去3日 `vwap_close_diff` 的最大值 (中间计算值)
- `ts_min_diff_3`: 过去3日 `vwap_close_diff` 的最小值 (中间计算值)
- `delta_volume_3`: 过去3日成交量的变化 (中间计算值)
- `rank_ts_max_diff_3`: `ts_max_diff_3` 的截面百分比排名 (中间计算值)
- `rank_ts_min_diff_3`: `ts_min_diff_3` 的截面百分比排名 (中间计算值)
- `rank_delta_volume_3`: `delta_volume_3` 的截面百分比排名 (中间计算值)
- `alpha11`: 计算得到的 Alpha#11 值，保留两位小数

## 注意事项与风险提示

- **数据窗口**：
  - `ts_max`, `ts_min` 和 `delta` 操作均涉及3天的时间窗口，因此计算开始时会有几天的NaN值。脚本中 `min_periods=3` 确保了只有在足够数据点时才计算 `ts_max` 和 `ts_min`。`delta(volume,3)` 也会导致前几行为NaN。
- **排名方法**：
  - 脚本中使用 `rank(method='average', pct=True)` 进行百分比排名，范围在0到1之间（如果数据点少或存在相同值，可能略有不同）。不同的排名方法（如 `min`, `max`, `first`）或是否使用 `pct=True` 可能会影响因子表现和值的分布。
- **数据质量**：
  - 确保输入的 `close`, `vwap`, `volume` 数据准确无误。异常值和缺失值（`NaN`）会影响计算结果。排名函数中的 `na_option='keep'` 参数会保留 `NaN` 值，而不是将它们视为极值。
- **解释性**：
  - Alpha#11是一个复合因子，其具体经济学含义和市场解释可能需要结合实际表现和进一步研究来深化。排名的引入使得Alpha值更多地反映相对强弱。
- **回测验证**：
  - 与所有量化因子一样，Alpha#11的有效性需要通过严格的回测来验证。历史表现不代表未来收益。

建议将 Alpha#11 与其他因子结合使用，并进行充分的回测和风险评估。
