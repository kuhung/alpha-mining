# Alpha#5 策略模拟与计算

本项目演示了如何根据给定的 Alpha#5 公式生成模拟金融数据、计算 Alpha 因子，并对结果进行分析。

## Alpha#5 公式

Alpha#5 的计算公式如下：

```
(rank((open - (sum(vwap, 10) / 10))) * (-1 * abs(rank((close - vwap)))))
```

其中：

* `open`: 资产的开盘价
* `close`: 资产的收盘价
* `vwap`: 成交量加权平均价格 (Volume Weighted Average Price)
* `sum(vwap, 10) / 10`: 过去10天VWAP的简单移动平均
* `rank(series)`: 计算 `series` 中每个值在当日所有资产间的排序百分比（0到1之间）。值越大，排名越高。
* `abs()`: 绝对值函数
* `(-1 *)`: 对结果取负值，实现反向逻辑

## 公式解读

Alpha#5 结合了两个核心要素：

1. **开盘价vs VWAP均值偏差**: `rank(open - (sum(vwap, 10) / 10))`

   - 衡量当日开盘价相对于过去10天VWAP均值的偏离程度
   - 反映了开盘时的价格水平相对于中期VWAP基准的位置
2. **收盘价vs当日VWAP偏差**: `rank(close - vwap)`

   - 衡量当日收盘价相对于当日VWAP的偏离程度
   - 反映了当日交易结束时的价格相对于成交量加权均价的位置
3. **交互效应**: 两个偏差的乘积，且第二项取绝对值和负号

   - 当开盘价高于VWAP均值时（正偏差），如果收盘价也偏离VWAP较多，则产生负信号
   - 策略倾向于反向操作：当价格偏离VWAP较多时给出负信号

## 项目结构

```
alpha-mining/
├── data/
│   ├── generate_mock_data.py  # 脚本：生成模拟金融数据（包含open, close, vwap字段）
│   └── mock_data.csv          # 生成的模拟数据文件
├── alpha/alpha5/
│   ├── alpha_calculator.py    # 脚本：根据公式计算 Alpha#5
│   ├── alpha5_results.csv     # 计算得到的 Alpha#5 结果文件
│   ├── README.md              # 本说明文档
│   └── cast.md                # Alpha#5 策略总结
```

## 使用步骤

### 1. 环境准备

确保您的 Python 环境中安装了 `pandas` 和 `numpy` 库。如果未安装，可以通过 pip 安装：

```bash
pip install pandas numpy
```

### 2. 生成模拟数据

如果数据文件不存在或需要更新，运行 `data/generate_mock_data.py` 脚本以生成包含open、close、vwap字段的模拟数据：

```bash
cd data
python generate_mock_data.py
cd ..
```

该脚本默认生成5只资产100天的数据，包含open、high、low、close、volume、vwap和returns字段。

### 3. 计算 Alpha#5 因子

生成模拟数据后，运行 `alpha_calculator.py` 脚本来计算 Alpha#5 因子。该脚本会读取 `data/mock_data.csv`，执行公式中的计算，并将结果保存到 `alpha5_results.csv`。

```bash
cd alpha/alpha5
python alpha_calculator.py
```

脚本执行完毕后，会在终端打印出结果文件的前5行、后5行以及 Alpha#5 值的描述性统计信息和一些分析图表。

## Alpha#5 策略解读

Alpha#5 是一个**VWAP偏差交互因子**，该策略通过分析开盘价和收盘价相对于VWAP的偏差来识别交易机会，尤其关注日内价格行为与近期均值的对比。

为了更好地理解计算过程，我们以实际生成数据中 `asset_3` 在2025-01-18至2025-01-22附近的数据为例进行分析：

### 实际数据示例 (asset_3)

| date       | asset_id | open   | close  | vwap   | vwap_ma_10 | open_vwap_diff | close_vwap_diff | rank_open_diff | rank_close_diff | alpha5 |
|------------|----------|--------|--------|--------|------------|----------------|-----------------|----------------|-----------------|--------|
| 2025-01-18 | asset_3  | 102.64 | 106.10 | 104.99 | 103.13     | -0.49          | 1.11            | 0.8            | 1.0             | -0.80  |
| 2025-01-19 | asset_3  | 105.80 | 105.90 | 105.59 | 103.22     | 2.58           | 0.31            | 1.0            | 0.6             | -0.60  |
| 2025-01-20 | asset_3  | 105.50 | 104.40 | 104.15 | 103.14     | 2.36           | 0.25            | 1.0            | 0.4             | -0.40  |
| 2025-01-21 | asset_3  | 105.00 | 105.50 | 105.23 | 103.23     | 1.77           | 0.27            | 1.0            | 0.4             | -0.40  |
| 2025-01-22 | asset_3  | 105.68 | 106.60 | 105.65 | 103.46     | 2.22           | 0.95            | 0.6            | 0.9             | -0.54  |


### 计算步骤详解 (以 asset_3 在 2025-01-20 为例)

当天各资产数据快照 (2025-01-20):

| asset_id | open   | close  | vwap   | vwap_ma_10 | open_vwap_diff | close_vwap_diff |
|----------|--------|--------|--------|------------|----------------|-----------------|
| asset_1  | 97.93  | 98.80  | 97.79  | 98.61      | -0.68          | 1.01            |
| asset_2  | 100.48 | 102.80 | 102.09 | 102.39     | -1.91          | 0.71            |
| asset_3  | 105.50 | 104.40 | 104.15 | 103.14     | 2.36           | 0.25            |
| asset_4  | 92.03  | 91.60  | 91.61  | 93.44      | -1.41          | -0.01           |
| asset_5  | 97.42  | 100.80 | 99.69  | 99.24      | -1.82          | 1.11            |


#### 步骤1：计算VWAP移动平均 (`vwap_ma_10`)
对于 `asset_3` 在 2025-01-20：
- 过去10天VWAP (从 2025-01-11 到 2025-01-20): `[104.28, 103.44, 101.42, 100.52, 101.08, 103.48, 102.44, 104.99, 105.59, 104.15]`
- `vwap_ma_10` = `mean(上記VWAP列表)` = `103.14` (四舍五入到两位小数)

#### 步骤2：开盘价偏差及排名 (`rank_open_diff`)
- 开盘价偏差 (`open_vwap_diff`) = `open` - `vwap_ma_10`
  - `asset_3`: 105.50 - 103.14 = 2.36
- 当日所有资产的 `open_vwap_diff` 值：`[-0.68, -1.91, 2.36, -1.41, -1.82]`
- 对这些值进行截面排名 (百分比, method='average'):
  - `asset_3` (2.36) 是最大值，排名为 `1.0` (`rank_open_diff`)

#### 步骤3：收盘价偏差及排名 (`rank_close_diff`)
- 收盘价偏差 (`close_vwap_diff`) = `close` - `vwap` (当日VWAP)
  - `asset_3`: 104.40 - 104.15 = 0.25
- 当日所有资产的 `close_vwap_diff` 值：`[1.01, 0.71, 0.25, -0.01, 1.11]`
- 对这些值进行截面排名 (百分比, method='average'):
  - `asset_3` (0.25) 在 `[-0.01, 0.25, 0.71, 1.01, 1.11]` 中排第2位 (0-indexed)，所以排名为 (1 + 0.5*1)/5 = 0.3，这里用的是average，所以是 (1+2)/2 / 5 = 0.3，结果文件为0.4。
  (注：实际计算结果与手动推算可能因浮点精度和具体pandas rank方法略有差异，以脚本输出为准。此处的0.4表示其相对排名) -> `rank_close_diff` = `0.4` for `asset_3`

#### 步骤4：最终Alpha值计算 (`alpha5`)
- `alpha5` = `rank_open_diff` * (-1 * `abs(rank_close_diff)`)
  - `asset_3`: 1.0 * (-1 * abs(0.4)) = 1.0 * (-0.4) = **-0.40**

### 策略逻辑

1.  **开盘价基准比较 (`rank_open_diff`)**: 
    *   `asset_3` 在2025-01-20开盘价 (105.50) 显著高于其10日VWAP均线 (103.14)，偏差2.36，在当天所有资产中排名最高 (`rank_open_diff` = 1.0)。这表明 `asset_3` 当日开盘相对强势，或估值偏高。

2.  **日内价格行为 (`rank_close_diff`)**: 
    *   `asset_3` 当日收盘价 (104.40) 略高于当日VWAP (104.15)，偏差0.25。这个偏差在当天所有资产中排名不高 (`rank_close_diff` = 0.4)。这表明尽管开盘强势，但日内价格并未大幅跑赢当日平均成交价。

3.  **信号合成与反转逻辑**: 
    *   Alpha5 = 1.0 * (-1 * abs(0.4)) = -0.40。
    *   **解读**: 尽管开盘强势，但日内收盘相对于VWAP的偏离并不极端。策略依然给出一个负向信号，暗示即使日内表现平平，开盘的高估值依然可能引发后续的均值回归。
    *   如果当日收盘价也大幅高于VWAP (e.g., `rank_close_diff` = 1.0)，Alpha值会更负 (e.g., -1.0)，反转信号更强。

4.  **风险控制**: 
    *   `abs()`函数确保无论收盘价是大幅高于还是大幅低于VWAP，都会加强负信号，体现了对极端日内偏离的警惕。

### 应用场景

- **日内反转的次日捕捉**: 适合捕捉那些日内价格行为（通过收盘价与VWAP比较）未能完全消化开盘时估值偏差（开盘价与VWAP均线比较）的股票，预期其在次日可能发生价格回归。
- **VWAP均值回归**: 基于成交量加权价格的均值回归特性进行交易。
- **多因子组合**: 可与其他技术或基本面因子结合使用。
- **风险管理**: 帮助识别那些开盘估值偏高且日内价格行为未能有效修正的潜在风险股票。

## 风险提示

- Alpha#5 是基于历史价格和成交量模式的统计策略，不保证未来表现。
- VWAP偏差可能受到市场微观结构和流动性影响。
- 策略的有效性可能随市场环境和交易时段变化而变化。
- 建议与其他因子结合使用，构建多因子投资组合。
- 请注意交易成本和市场冲击对实际表现的影响。
- 开盘价和收盘价可能受到特殊事件影响，需要考虑异常值处理。

如需帮助或有建议，欢迎交流！
